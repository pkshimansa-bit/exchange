<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Chat | Bet Win</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --neon: #00f2ff; --bg-dark: #000428; --glass: rgba(255, 255, 255, 0.05); }
        
        body { 
            margin: 0; font-family: 'Segoe UI', sans-serif; 
            background: radial-gradient(circle at center, #004e92 0%, var(--bg-dark) 100%);
            background-attachment: fixed; color: white; display: flex; flex-direction: column; height: 100vh;
        }

        /* Top Header */
        .chat-header { 
            padding: 20px; background: rgba(0,0,0,0.4); display: flex; 
            align-items: center; border-bottom: 1px solid rgba(0,242,255,0.2); 
        }
        .back-btn { font-size: 24px; color: var(--neon); margin-right: 15px; cursor: pointer; }
        .header-title { font-size: 18px; font-weight: bold; letter-spacing: 1px; }

        /* Reward Alert Bar */
        #rewardStatus { 
            background: rgba(0, 242, 255, 0.1); border-bottom: 1px solid var(--neon);
            padding: 10px; font-size: 12px; text-align: center; display: none; font-weight: bold;
        }

        /* Message Area */
        #chatMessages { 
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; 
        }
        .bubble { max-width: 80%; padding: 12px 16px; border-radius: 20px; font-size: 14px; line-height: 1.5; }
        .bubble.admin { align-self: flex-start; background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-bottom-left-radius: 4px; }
        .bubble.me { align-self: flex-end; background: var(--neon); color: #000; font-weight: 500; border-bottom-right-radius: 4px; }
        .bubble.broadcast { align-self: center; background: rgba(255, 215, 0, 0.1); border: 1px solid #ffd700; color: #ffd700; width: 90%; text-align: center; font-weight: bold; }

        /* Input Section */
        .input-bar { 
            padding: 20px; background: rgba(0,0,0,0.5); display: flex; gap: 10px; align-items: center;
            border-top: 1px solid rgba(255,255,255,0.1); 
        }
        #msgInp { 
            flex: 1; padding: 14px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05); color: white; outline: none;
        }
        #msgInp:disabled { background: rgba(255, 0, 0, 0.05); border-color: #ff4d4d; color: #ff4d4d; cursor: not-allowed; }
        .send-btn { 
            background: var(--neon); border: none; width: 48px; height: 48px; 
            border-radius: 50%; color: #000; cursor: pointer; transition: 0.3s;
        }
    </style>
</head>
<body>

    <div class="chat-header">
        <i class="fas fa-chevron-left back-btn" onclick="history.back()"></i>
        <div class="header-title">CUSTOMER SUPPORT</div>
    </div>

    <div id="rewardStatus"></div>

    <div id="chatMessages">
        </div>

    <div class="input-bar">
        <input type="text" id="msgInp" placeholder="Type your message...">
        <button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { 
             authDomain: "sha1-105ac.firebaseapp.com",
  databaseURL: "https://sha1-105ac-default-rtdb.firebaseio.com",
  projectId: "sha1-105ac",
  storageBucket: "sha1-105ac.firebasestorage.app",
  messagingSenderId: "1056846099713",
  appId: "1:1056846099713:web:c27970161f7a2493db1700",
  measurementId: "G-T1EK6X2N48"
         };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const phone = localStorage.getItem("userPhone");

        let rewardTimer = null;

        async function initChat() {
            if(!phone) return;

            // 1. ‡∂á‡∂©‡∑ä‡∂∏‡∑í‡∂±‡∑ä Broadcast ‡∑É‡∑Ñ Reward ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è‡∑Ä
            onValue(ref(db, 'adminSettings/isBroadcasting'), async (snap) => {
                const isLive = snap.val();
                const userSnap = await get(ref(db, `users/${phone}`));
                const userVIP = userSnap.exists() ? userSnap.val().currentVIP : "level_0";
                
                const bar = document.getElementById('rewardStatus');
                const inp = document.getElementById('msgInp');

                if(isLive) {
                    bar.style.display = 'block';
                    inp.disabled = true; // ‡∂á‡∂©‡∑ä‡∂∏‡∑í‡∂±‡∑ä ‡∂Ω‡∂∫‡∑í‡∑Ä‡∑ä ‡∂±‡∑í‡∑É‡∑è ‡∂â‡∂±‡∑ä‡∂¥‡∑î‡∂ß‡∑ä ‡∂ë‡∂ö ‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
                    
                    if(userVIP !== "level_0") {
                        bar.innerHTML = `<i class="fas fa-gift"></i> VIP REWARD ACTIVE: LKR 50.00 / minute is being added!`;
                        if(!rewardTimer) rewardTimer = setInterval(() => addReward(50), 60000);
                    } else {
                        bar.innerHTML = `<i class="fas fa-lock"></i> UPGRADE VIP to earn rewards during Admin Broadcast!`;
                    }
                } else {
                    bar.style.display = 'none';
                    inp.disabled = false;
                    if(rewardTimer) { clearInterval(rewardTimer); rewardTimer = null; }
                }
            });

            // 2. ‡∂∏‡∑ê‡∑É‡∑ö‡∂¢‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏ (Personal & Broadcast)
            onValue(ref(db, `chats/${phone}`), () => renderAllMsgs());
            onValue(ref(db, `groupChat`), () => renderAllMsgs());
        }

        async function renderAllMsgs() {
            const container = document.getElementById('chatMessages');
            container.innerHTML = "";
            let msgs = [];

            // ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ ‡∂†‡∑ê‡∂ß‡∑ä ‡∂ë‡∂ö
            const pSnap = await get(ref(db, `chats/${phone}`));
            if(pSnap.exists()) Object.values(pSnap.val()).forEach(m => msgs.push({...m, type: m.sender==='admin'?'admin':'me'}));

            // ‡∂∂‡∑ä‚Äç‡∂ª‡∑ù‡∂©‡∑ä‡∂ö‡∑è‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö
            const gSnap = await get(ref(db, `groupChat`));
            if(gSnap.exists()) Object.values(gSnap.val()).forEach(m => msgs.push({...m, type: 'broadcast'}));

            msgs.sort((a,b) => a.timestamp - b.timestamp);
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = `bubble ${m.type}`;
                div.innerText = (m.type==='broadcast'?'üì¢ ADMIN: ':'') + m.text;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        window.sendMsg = async () => {
            const inp = document.getElementById('msgInp');
            if(!inp.value.trim()) return;
            await push(ref(db, `chats/${phone}`), { sender: 'member', text: inp.value, timestamp: Date.now() });
            inp.value = "";
        };

        async function addReward(amt) {
            const userSnap = await get(ref(db, `users/${phone}`));
            if(userSnap.exists()){
                const d = userSnap.val();
                await update(ref(db, `users/${phone}`), { 
                    balance: (d.balance || 0) + amt, 
                    totalInc: (d.totalInc || 0) + amt
                });
            }
        }

        initChat();
    </script>
</body>
</html>

